name: Build and Push Docker Images

on:
  push:
    branches:
      - main  # main 브랜치에 푸시될 때 실행

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Images
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        run: |
          # 서비스 목록
          SERVICES=("configserver" "eurekaserver" "gatewayserver" "jobbotdari" "jobbotdari_user")

          for SERVICE in "${SERVICES[@]}"
          do
            IMAGE_NAME="$DOCKER_HUB_USERNAME/$SERVICE"
            IMAGE_TAG="latest"
            CONTEXT="./$SERVICE"
            DOCKERFILE="$CONTEXT/Dockerfile"

            echo "Building and pushing $IMAGE_NAME:$IMAGE_TAG"

            docker build -t $IMAGE_NAME:$IMAGE_TAG -f $DOCKERFILE $CONTEXT
            docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:${{ github.sha }}
            docker push $IMAGE_NAME:$IMAGE_TAG
            docker push $IMAGE_NAME:${{ github.sha }}
          done
